<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Backoffice | Productos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .td-actions { white-space: nowrap; }
    .price-input { max-width: 140px; }
    .sku-input { max-width: 140px; }
    .cat-input { max-width: 200px; }
    .unit-input { max-width: 90px; }
    .type-input { max-width: 140px; }
    .pos-col { min-width: 150px; }
    .small-muted { color:#6c757d; font-size: .85rem; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/admin">üßæ Backoffice</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navAdmin">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navAdmin">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/admin">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/settings">Configuraci√≥n</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/cash">Caja</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin/products/ui">Productos</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/purchases/ui">Compras</a></li>
        <li class="nav-item"><a class="nav-link" href="/pos">POS</a></li>
        <li class="nav-item"><a class="nav-link" href="/cocina">Cocina</a></li>
      </ul>

      <span class="navbar-text text-light small">
        {{ business_name }}
      </span>
    </div>
  </div>
</nav>

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h3 class="fw-bold mb-0">Productos</h3>
      <div class="text-muted">
        Crear, editar precio, categor√≠a y activar/desactivar.
        <span class="small-muted">Tip: para insumos (Harina/Aceite), desmarca ‚ÄúMostrar en POS‚Äù.</span>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="btnReload">Actualizar</button>
      <a class="btn btn-secondary" href="/admin">Volver</a>
    </div>
  </div>

  <div id="alertBox"></div>

  <!-- Filtros -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Buscar</label>
          <input class="form-control" id="q" placeholder="Nombre o SKU...">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Categor√≠a</label>
          <select class="form-select" id="category">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="col-6 col-md-2">
          <label class="form-label">Activo</label>
          <select class="form-select" id="active">
            <option value="">Todos</option>
            <option value="1">Activos</option>
            <option value="0">Inactivos</option>
          </select>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Mostrar en POS</label>
          <select class="form-select" id="showInPosFilter">
            <option value="">Todos</option>
            <option value="1">S√≠ (Ventas)</option>
            <option value="0">No (Insumos)</option>
          </select>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary" id="btnSearch">Filtrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Crear producto -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="fw-bold mb-2">‚ûï Crear producto</div>

      <div class="row g-2">
        <div class="col-12 col-md-2">
          <input class="form-control mono" id="newSku" placeholder="SKU">
        </div>

        <div class="col-12 col-md-3">
          <input class="form-control" id="newName" placeholder="Nombre *">
        </div>

        <div class="col-12 col-md-2">
          <input class="form-control" id="newCategory" placeholder="Categor√≠a">
        </div>

        <div class="col-6 col-md-2">
          <select class="form-select" id="newType" title="Tipo">
            <option value="sale" selected>Venta</option>
            <option value="supply">Insumo</option>
          </select>
        </div>

        <div class="col-6 col-md-1">
          <input class="form-control unit-input mono" id="newUnit" placeholder="UN" title="Unidad (UN/KG/LT)">
        </div>

        <div class="col-6 col-md-1">
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="newShowInPos" checked>
            <label class="form-check-label" for="newShowInPos">POS</label>
          </div>
        </div>

        <div class="col-6 col-md-1">
          <input class="form-control mono text-end" id="newPrice" placeholder="Precio" inputmode="numeric" title="Precio venta (solo si es Venta)">
        </div>

        <div class="col-12 col-md-1 d-grid">
          <button class="btn btn-success" id="btnCreate">Crear</button>
        </div>
      </div>

      <div class="text-muted small mt-2">
        * nombre obligatorio. Si es <strong>Insumo</strong>, normalmente el precio de venta es 0 y ‚ÄúMostrar en POS‚Äù va desmarcado.
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>SKU</th>
              <th>Nombre</th>
              <th>Categor√≠a</th>
              <th>Tipo</th>
              <th>Unidad</th>
              <th class="text-end">Precio</th>
              <th class="pos-col">Mostrar en POS</th>
              <th>Estado</th>
              <th class="td-actions text-end">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="small-muted mt-2">
        ‚úÖ Para ‚ÄúHarina‚Äù, crea como <strong>Insumo</strong> y desmarca ‚ÄúMostrar en POS‚Äù. As√≠ aparecer√° en Compras pero no en POS.
      </div>
    </div>
  </div>

</div>

<script>
  const $ = (id) => document.getElementById(id);

  const alertBox = $("alertBox");
  const tbody = $("tbody");

  const q = $("q");
  const category = $("category");
  const active = $("active");
  const showInPosFilter = $("showInPosFilter");
  const btnSearch = $("btnSearch");
  const btnReload = $("btnReload");

  const newSku = $("newSku");
  const newName = $("newName");
  const newCategory = $("newCategory");
  const newPrice = $("newPrice");
  const newType = $("newType");
  const newUnit = $("newUnit");
  const newShowInPos = $("newShowInPos");
  const btnCreate = $("btnCreate");

  function showAlert(type, msg){
    alertBox.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(() => { alertBox.innerHTML = ""; }, 3500);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ============================
  // parse CL + format
  // ============================
  function parseCLNumber(raw){
    if (raw === null || raw === undefined) return 0;
    let s = String(raw).trim();
    if (!s) return 0;

    s = s.replace(/\s+/g, "");
    s = s.replace(/\$/g, "");

    if (s.includes(".") && s.includes(",")) {
      s = s.replace(/\./g, "");
      s = s.replace(",", ".");
    } else if (s.includes(".") && !s.includes(",")) {
      if ((s.match(/\./g) || []).length > 1) {
        s = s.replace(/\./g, "");
      } else {
        const parts = s.split(".");
        if (parts[1] && parts[1].length === 3) s = parts[0] + parts[1];
      }
    } else if (s.includes(",") && !s.includes(".")) {
      s = s.replace(",", ".");
    }

    const n = Number(s);
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function formatCLP(n){
    try { return "$" + Number(n || 0).toLocaleString("es-CL"); }
    catch { return "$" + (n || 0); }
  }

  function formatCLInput(el){
    const n = parseCLNumber(el.value);
    if (n === null) return;
    const intVal = Math.round(n);
    el.value = String(intVal.toLocaleString("es-CL"));
  }

  function normalizeForSend(raw){
    const n = parseCLNumber(raw);
    if (n === null) return null;
    return String(Math.round(n));
  }

  async function loadCategories(){
    const r = await fetch("/admin/products/categories");
    const j = await r.json();
    if (!j.ok) return;

    const prev = category.value;

    category.innerHTML = `<option value="">Todas</option>` +
      (j.items || []).map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

    category.value = prev;
  }

  async function loadProducts(){
    const params = new URLSearchParams();
    if (q.value.trim()) params.set("q", q.value.trim());
    if (category.value) params.set("category", category.value);
    if (active.value) params.set("active", active.value);

    // Nota: este filtro es UI (si tu backend a√∫n no filtra show_in_pos, filtramos ac√°)
    const showFilter = showInPosFilter.value;

    const r = await fetch("/admin/products?" + params.toString());
    const j = await r.json();

    if (!j.ok){
      showAlert("danger", j.error || "No se pudo cargar productos");
      return;
    }

    let items = j.items || [];

    if (showFilter === "1") items = items.filter(x => (x.show_in_pos ?? true) === true);
    if (showFilter === "0") items = items.filter(x => (x.show_in_pos ?? true) === false);

    tbody.innerHTML = items.map(renderRow).join("");

    hookPriceFormatters();
  }

  function renderRow(p){
    const statusBadge = p.active
      ? `<span class="badge bg-success">Activo</span>`
      : `<span class="badge bg-secondary">Inactivo</span>`;

    const priceVal = Number(p.price || 0);
    const priceInputVal = Number.isFinite(priceVal) ? Math.round(priceVal).toLocaleString("es-CL") : "0";

    const pType = (p.product_type || "sale");
    const unit = (p.unit || "UN");

    const showInPos = (p.show_in_pos ?? true) === true;

    return `
      <tr data-id="${p.id}">
        <td class="mono">${p.id}</td>

        <td><input class="form-control form-control-sm mono sku-input" value="${escapeHtml(p.sku || "")}" data-field="sku"></td>
        <td><input class="form-control form-control-sm" value="${escapeHtml(p.name || "")}" data-field="name"></td>
        <td><input class="form-control form-control-sm cat-input" value="${escapeHtml(p.category || "")}" data-field="category"></td>

        <td>
          <select class="form-select form-select-sm type-input" data-field="product_type">
            <option value="sale" ${pType === "sale" ? "selected" : ""}>Venta</option>
            <option value="supply" ${pType === "supply" ? "selected" : ""}>Insumo</option>
          </select>
        </td>

        <td>
          <input class="form-control form-control-sm mono unit-input"
                 value="${escapeHtml(unit)}"
                 data-field="unit"
                 placeholder="UN">
        </td>

        <td class="text-end">
          <input class="form-control form-control-sm mono price-input text-end"
                 value="${priceInputVal}"
                 data-field="price"
                 inputmode="numeric"
                 data-role="price">
          <div class="text-muted small" data-role="price-preview">${formatCLP(priceVal)}</div>
        </td>

        <td class="pos-col">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" data-field="show_in_pos" ${showInPos ? "checked" : ""}>
            <label class="form-check-label">${showInPos ? "S√≠" : "No"}</label>
          </div>
          <div class="small-muted">Oculta insumos del POS</div>
        </td>

        <td>${statusBadge}</td>

        <td class="td-actions text-end">
          <button class="btn btn-sm btn-primary" onclick="saveRow(${p.id})">Guardar</button>
          <button class="btn btn-sm ${p.active ? "btn-outline-secondary" : "btn-outline-success"}" onclick="toggleActive(${p.id}, ${p.active ? "false" : "true"})">
            ${p.active ? "Desactivar" : "Activar"}
          </button>
        </td>
      </tr>
    `;
  }

  function hookPriceFormatters(){
    const inputs = tbody.querySelectorAll('input[data-role="price"]');
    inputs.forEach(inp => {
      if (inp.dataset.bound === "1") return;
      inp.dataset.bound = "1";

      inp.addEventListener("blur", () => {
        formatCLInput(inp);
        updatePricePreview(inp);
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          formatCLInput(inp);
          updatePricePreview(inp);

          const tr = inp.closest("tr");
          const id = tr?.dataset?.id;
          if (id) saveRow(Number(id));
        }
      });

      inp.addEventListener("input", () => updatePricePreview(inp));
    });

    // Label del switch show_in_pos
    const switches = tbody.querySelectorAll('input[type="checkbox"][data-field="show_in_pos"]');
    switches.forEach(sw => {
      if (sw.dataset.bound === "1") return;
      sw.dataset.bound = "1";
      sw.addEventListener("change", () => {
        const label = sw.closest("td")?.querySelector(".form-check-label");
        if (label) label.textContent = sw.checked ? "S√≠" : "No";
      });
    });
  }

  function updatePricePreview(inp){
    const tr = inp.closest("tr");
    const preview = tr?.querySelector('[data-role="price-preview"]');
    if (!preview) return;
    const n = parseCLNumber(inp.value);
    preview.textContent = (n === null) ? "Precio inv√°lido" : formatCLP(n);
  }

  function getRowData(id){
    const tr = tbody.querySelector(`tr[data-id="${id}"]`);
    const inputs = tr.querySelectorAll("input[data-field], select[data-field]");
    const data = {};
    inputs.forEach(el => {
      const key = el.dataset.field;
      if (el.type === "checkbox") data[key] = el.checked;
      else data[key] = el.value;
    });
    return data;
  }

  async function saveRow(id){
    const data = getRowData(id);

    const payload = {
      sku: (data.sku || "").trim() || null,
      name: (data.name || "").trim(),
      category: (data.category || "").trim() || null,
      price: normalizeForSend(data.price),
      product_type: (data.product_type || "sale"),
      unit: (data.unit || "UN").trim() || "UN",
      show_in_pos: !!data.show_in_pos
    };

    if (!payload.name){
      showAlert("warning", "El nombre no puede ir vac√≠o");
      return;
    }
    if (payload.price === null){
      showAlert("danger", "price inv√°lido");
      return;
    }

    // Si es insumo, por defecto no mostrar en POS y precio 0 (opcional)
    if (payload.product_type === "supply") {
      payload.show_in_pos = false;
      // Si quieres forzar precio 0 para insumo, descomenta:
      // payload.price = "0";
    }

    const r = await fetch(`/admin/products/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();

    if (!r.ok || !j.ok){
      showAlert("danger", j.error || "No se pudo guardar");
      return;
    }

    showAlert("success", "‚úÖ Guardado");
    await loadCategories();
    await loadProducts();
  }

  async function toggleActive(id, value){
    const r = await fetch(`/admin/products/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ active: !!value })
    });
    const j = await r.json();

    if (!r.ok || !j.ok){
      showAlert("danger", j.error || "No se pudo cambiar estado");
      return;
    }

    showAlert("success", value ? "‚úÖ Activado" : "‚úÖ Desactivado");
    await loadProducts();
  }

  async function createProduct(){
    const payload = {
      sku: (newSku.value || "").trim() || null,
      name: (newName.value || "").trim(),
      category: (newCategory.value || "").trim() || null,
      price: normalizeForSend(newPrice.value || "0"),
      product_type: (newType.value || "sale"),
      unit: (newUnit.value || "UN").trim() || "UN",
      show_in_pos: !!newShowInPos.checked
    };

    if (!payload.name){
      showAlert("warning", "El nombre es obligatorio");
      return;
    }
    if (payload.price === null){
      showAlert("danger", "price inv√°lido");
      return;
    }

    // Si es insumo: por defecto no mostrar en POS
    if (payload.product_type === "supply") {
      payload.show_in_pos = false;
      // (opcional) forzar precio 0:
      // payload.price = "0";
    }

    const r = await fetch("/admin/products", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();

    if (!r.ok || !j.ok){
      showAlert("danger", j.error || "No se pudo crear");
      return;
    }

    showAlert("success", "‚úÖ Producto creado");
    newSku.value = "";
    newName.value = "";
    newCategory.value = "";
    newPrice.value = "";
    newType.value = "sale";
    newUnit.value = "UN";
    newShowInPos.checked = true;

    await loadCategories();
    await loadProducts();
  }

  // Formatear precio creaci√≥n
  newPrice.addEventListener("blur", () => formatCLInput(newPrice));
  newPrice.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      formatCLInput(newPrice);
      createProduct();
    }
  });

  // Auto toggle: si seleccionas "Insumo" al crear, apaga POS
  newType.addEventListener("change", () => {
    if (newType.value === "supply") newShowInPos.checked = false;
    else newShowInPos.checked = true;
  });

  btnSearch.addEventListener("click", () => loadProducts());
  btnReload.addEventListener("click", async () => {
    await loadCategories();
    await loadProducts();
  });

  btnCreate.addEventListener("click", createProduct);

  loadCategories().then(loadProducts);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>